# yamllint disable rule:line-length
---
name: Update SHA256 Checksums

'on':
  workflow_dispatch:
    inputs:
      formula:
        description: 'Formula name to update (leave empty for all)'
        required: false
        type: string
      version:
        description: 'Version string (e.g. 2.0.0) to set on matching formulas (optional)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  update-checksums:
    name: Update SHA256 Checksums
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        # yamllint disable-next-line rule:line-length
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email \
            "github-actions[bot]@users.noreply.github.com"

      - name: Update checksums
        id: update
        run: |
          set -e
          updated=""
          formula_input="${{ github.event.inputs.formula }}"
          version_input="${{ github.event.inputs.version }}"

          # Build candidate list
          if [ -n "$formula_input" ]; then
            candidates=("Formula/${formula_input}.rb")
          else
            shopt -s nullglob
            candidates=(Formula/*.rb)
          fi

          for formula in "${candidates[@]}"; do
            if [ -f "$formula" ]; then
              formula_name=$(basename "$formula" .rb)

              # Skip example formula
              if [ "$formula_name" = "example-tool" ]; then
                echo "Skipping example formula: $formula_name"
                continue
              fi

              echo "Updating checksums in $formula..."

              ruby <<'RUBY' "$formula" "$formula_name" "$version_input"
              require 'open3'
              require 'shellwords'

              path         = ARGV[0]
              formula_name = ARGV[1]
              version_arg  = ARGV[2]

              contents = File.read(path)

              if version_arg && !version_arg.empty? && formula_name == 'transcribe'
                contents = contents.sub(/version "[^"]+"/, %(version "#{version_arg}"))
              end

              contents = contents.gsub(/(url "([^"]+)")\n(\s*sha256 ")([^"]*)"/) do
                url        = Regexp.last_match(2)
                sha_prefix = Regexp.last_match(3)
                old_sha    = Regexp.last_match(4)

                cmd = "curl -sSL #{Shellwords.escape(url)} | shasum -a 256"
                puts "  Computing SHA256 for #{url}..."
                stdout, status = Open3.capture2('bash', '-lc', cmd)

                unless status.success?
                  warn "  Failed to compute SHA for #{url}"
                  next Regexp.last_match(0)
                end

                new_sha = stdout.split.first
                if new_sha.nil? || new_sha.empty?
                  warn "  Empty SHA for #{url}"
                  next Regexp.last_match(0)
                end

                if new_sha == old_sha
                  puts "  SHA unchanged for #{url}"
                  Regexp.last_match(0)
                else
                  puts "  Updated SHA: #{old_sha} -> #{new_sha}"
                  "#{Regexp.last_match(1)}\n#{sha_prefix}#{new_sha}\""
                end
              end

              File.write(path, contents)
              RUBY

              if git diff --quiet "$formula"; then
                echo "No changes needed for $formula_name"
              else
                echo "Updated checksums for $formula_name"
                updated="${updated}${formula_name} "
              fi
            fi
          done

          echo "updated=$updated" >> "$GITHUB_OUTPUT"

      - name: Create Pull Request
        if: steps.update.outputs.updated != ''
        # yamllint disable-next-line rule:line-length
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e  # v7.0.8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update SHA256 checksums"
          title: "chore: Update SHA256 checksums"
          body: |
            ## SHA256 Checksum Updates

            This PR updates SHA256 checksums for formulas.

            **Updated formulas**: ${{ steps.update.outputs.updated }}

            ### Checklist
            - [x] SHA256 checksums updated
            - [ ] Manual review required
            - [ ] Tests pass

            Please review and merge if tests pass.
          branch: update-checksums
          delete-branch: true
          labels: |
            automated
            checksums

      - name: Summary
        run: |
          echo "Checksum update completed"
          echo "Updated formulas: ${{ steps.update.outputs.updated }}"
